#!/usr/bin/env python
import functools
import signal
import sys

from itertools import starmap
from pprint import pprint
from subprocess import Popen

import baker

from warhol import warhol, helpers


moduleformat = 'warhol.warhol:init(filename="{}")'.format


def sigint(proc, *args):
    """Kill gunicorn when we get a sigint."""
    proc.terminate()


def gunicorn(module, options):
    """Launch gunicorn to handle the worker threads."""

    arguments = {'name': 'warhol',
                 'bind': '127.0.0.1:1928',
                 'workers': 2,
                 'log-level': 'error'}

    arguments.update(options)

    args = starmap('--{}={}'.format, options.iteritems())

    command = ('gunicorn', '--preload') + tuple(args) + (module, )
    return Popen(command, stdout=sys.stdout, stdin=sys.stdin, shell=False)


if __name__ == '__main__':
    filename = helpers.fullpath(sys.argv[1])
    print('configuration: {}'.format(filename))

    gunicorn(moduleformat(filename), {})

    # options = config.get('gunicorn', {})
    # workers = warhol.gunicorn(app, **options)
    # signal.signal(signal.SIGINT, functools.partial(warhol.sigint, warhol.workers))
    # warhol.workers.wait()
    exit(0)
